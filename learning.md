ç³»ç»Ÿçš„åŠ¨æ€åˆ†é…å‡½æ•°new malloc free delete

stlç›¸å…³

mutex

size_t



ç”³è¯·ä¸€å—è¾ƒå¤§çš„å†…å­˜å—ï¼Œä¹‹åå°†è¿™å—å†…å­˜çš„ç®¡ç†æ”¾åœ¨åº”ç”¨å±‚è¿›è¡Œï¼Œå‡å°ç³»ç»Ÿè°ƒç”¨å¸¦æ¥çš„å¼€é”€

- å‡å°åŠ¨æ€å†…å­˜åˆ†é…çš„å¼€é”€
- é¿å…å†…å­˜ç¢ç‰‡
- é™ä½ç³»ç»Ÿè°ƒç”¨é¢‘ç‡
- æ‹¥æœ‰ç¨³å®šçš„åˆ†é…æ—¶é—´

é€‚ç”¨åœºåˆï¼šæ¸¸æˆå¼€å‘ä¸­å¤§é‡å°å¯¹è±¡ã€é«˜æ€§èƒ½è®¡ç®—ã€webæœåŠ¡å™¨å’Œæ•°æ®åº“æœåŠ¡å™¨å¤„ç†å¤§é‡è¿æ¥å’Œè¯·æ±‚

ç¼ºç‚¹ï¼šéœ€è¦é¢„å…ˆåˆ†é…è¾ƒå¤§çš„å†…å­˜åŒºåŸŸï¼Œå¯èƒ½æµªè´¹ä¸€äº›å†…å­˜ï¼›å¯¹å¤§å¯¹è±¡çš„åˆ†é…å¹¶ä¸åˆ’ç®—



## cppå­¦ä¹ 



### æ•°æ®ç±»å‹

| æ•°æ®ç±»å‹      | 32 ä½ç³»ç»Ÿ   | 64 ä½ç³»ç»Ÿ | è¯´æ˜                                             |
| ------------- | ----------- | --------- | ------------------------------------------------ |
| `bool`        | 1           | 1         | ä»…èƒ½å– `true` æˆ– `false`                         |
| `char`        | 1           | 1         | å­˜å‚¨å•ä¸ªå­—ç¬¦ï¼ˆASCII æˆ– Unicodeï¼‰                 |
| `wchar_t`     | 2 æˆ– 4      | 4         | å®½å­—ç¬¦ç±»å‹ï¼ˆå­˜å‚¨ Unicodeï¼‰                       |
| `char16_t`    | 2           | 2         | 16 ä½å­—ç¬¦ï¼ˆUTF-16ï¼‰                              |
| `char32_t`    | 4           | 4         | 32 ä½å­—ç¬¦ï¼ˆUTF-32ï¼‰                              |
| `short`       | 2           | 2         | çŸ­æ•´æ•°ï¼ˆé€šå¸¸ä¸º 16 ä½ï¼‰                           |
| `int`         | 4           | 4         | æ ‡å‡†æ•´æ•°ï¼ˆé€šå¸¸ä¸º 32 ä½ï¼‰                         |
| `long`        | 4           | 8         | åœ¨ 32 ä½ç³»ç»Ÿä¸­ä¸º 4 å­—èŠ‚ï¼Œåœ¨ 64 ä½ç³»ç»Ÿä¸­ä¸º 8 å­—èŠ‚ |
| `long long`   | 8           | 8         | é•¿æ•´å‹ï¼ˆé€šå¸¸ä¸º 64 ä½ï¼‰                           |
| `float`       | 4           | 4         | å•ç²¾åº¦æµ®ç‚¹æ•°ï¼ˆIEEE 754 æ ‡å‡†ï¼‰                    |
| `double`      | 8           | 8         | åŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆIEEE 754 æ ‡å‡†ï¼‰                    |
| `long double` | 8ã€12 æˆ– 16 | 16        | å¯èƒ½å› ç¼–è¯‘å™¨ä¸åŒè€Œå˜åŒ–                           |

**æŒ‡é’ˆç±»å‹**

| æŒ‡é’ˆç±»å‹                              | 32 ä½ç³»ç»Ÿ | 64 ä½ç³»ç»Ÿ | è¯´æ˜                               |
| ------------------------------------- | --------- | --------- | ---------------------------------- |
| æŒ‡å‘ `char`ã€`int`ã€`double` ç­‰çš„æŒ‡é’ˆ | 4         | 8         | æŒ‡é’ˆçš„å¤§å°å–å†³äºå¹³å°åœ°å€æ€»çº¿çš„å®½åº¦ |

- `sizeof(type)` å¯ä»¥ç”¨äºæŸ¥çœ‹æ•°æ®ç±»å‹çš„å…·ä½“å¤§å°ã€‚
- `long` åœ¨ 32 ä½ç³»ç»Ÿä¸­é€šå¸¸æ˜¯ 4 å­—èŠ‚ï¼Œè€Œåœ¨ 64 ä½ç³»ç»Ÿä¸­å¯èƒ½æ˜¯ 8 å­—èŠ‚ï¼ˆå¦‚ Linuxï¼‰ã€‚



### å¸¸é‡æŒ‡é’ˆä¸æŒ‡é’ˆå¸¸é‡

**å¸¸é‡æŒ‡é’ˆ**

`*p`ï¼ˆæŒ‡å‘çš„å€¼ï¼‰ä¸èƒ½ä¿®æ”¹ï¼Œä½† `p`ï¼ˆæŒ‡é’ˆæœ¬èº«ï¼‰å¯ä»¥æ”¹å˜æŒ‡å‘å…¶ä»–åœ°å€ã€‚

```cpp
const int *p;  // ç­‰ä»·äº int const *p;
```

**æŒ‡é’ˆå¸¸é‡**

æŒ‡é’ˆæœ¬èº«ä¸å¯ä¿®æ”¹ï¼Œä½†å®ƒæŒ‡å‘çš„å€¼å¯ä»¥æ›´æ”¹

```cpp
int *const p = &a;
```



### defineã€typedefå’Œinline

#### define

`#define` æ˜¯ é¢„å¤„ç†æŒ‡ä»¤ï¼Œç”¨äºå®šä¹‰ å®ï¼Œå¯ä»¥ç”¨æ¥å®šä¹‰ å¸¸é‡ æˆ– ä»£ç ç‰‡æ®µã€‚å®ƒæ˜¯åœ¨ ç¼–è¯‘å‰ ç”± é¢„å¤„ç†å™¨ è¿›è¡Œæ›¿æ¢çš„ï¼Œè€Œä¸æ˜¯ç”±ç¼–è¯‘å™¨è§£æçš„ã€‚

- æ²¡æœ‰ç±»å‹æ£€æŸ¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„æƒ³ä¸åˆ°çš„é”™è¯¯ã€‚
- åªæ˜¯ ç®€å•çš„æ–‡æœ¬æ›¿æ¢ã€‚
- æ— æ³•è°ƒè¯•ï¼ˆå› ä¸ºå®ƒåœ¨ç¼–è¯‘å‰è¢«æ›¿æ¢ï¼‰ã€‚

```cpp
#define PI 3.14159  // å®šä¹‰å¸¸é‡
#define SQUARE(x) ((x) * (x))  // å®å‡½æ•°
```

æ³¨æ„ï¼š

```cpp
cout << SQUARE(5 + 1) << endl;  // æœŸå¾… (5+1) * (5+1) = 36
```

ç”±äº `#define SQUARE(x) ((x) * (x))`ï¼Œå®é™…å±•å¼€æ˜¯ï¼š

```cpp
((5+1) * (5+1))  // ç»“æœï¼š6 * 6 = 36
```

å¦‚æœ `#define SQUARE(x) (x * x)`ï¼Œé‚£ä¹ˆï¼š

```cpp
(5+1 * 5+1)  // ç»“æœï¼š5 + 5 + 1 = 11ï¼ˆé”™è¯¯ï¼ï¼‰
```

ä½¿ç”¨ `#define` å®šä¹‰å®æ—¶ï¼Œå‚æ•°æœ€å¥½ç”¨æ‹¬å·æ‹¬èµ·æ¥ï¼Œé¿å…è¿ç®—ç¬¦ä¼˜å…ˆçº§é—®é¢˜ã€‚



#### typedef

`typedef` ç”¨äºç»™å·²æœ‰çš„ç±»å‹ **åˆ›å»ºä¸€ä¸ªæ–°çš„åç§°**ï¼Œè®©ä»£ç æ›´ç®€æ´æ˜“è¯»ã€‚

- åªåšç±»å‹é‡å‘½åï¼Œä¸ä¼šåˆ›å»ºæ–°çš„æ•°æ®ç±»å‹ã€‚
- åœ¨ç¼–è¯‘æ—¶ç”Ÿæ•ˆï¼ˆä¸åƒ `#define` åªæ˜¯æ–‡æœ¬æ›¿æ¢ï¼‰ã€‚
- æ”¯æŒå¤æ‚ç±»å‹ï¼Œå¯æé«˜å¯è¯»æ€§ã€‚

```cpp
#include <iostream>
using namespace std;

typedef unsigned int uint;  // uint æ˜¯ unsigned int çš„åˆ«å
typedef int* IntPtr;  // IntPtr ä»£è¡¨ int* ç±»å‹

int main() {
    uint a = 100;  // ç­‰ä»·äº unsigned int a = 100;
    IntPtr p;  // ç­‰ä»·äº int* p;
    cout << "a: " << a << endl;
    return 0;
}
```

**æ³¨æ„**

```cpp
typedef int* IntPtr;
IntPtr p1, p2;
```

è¿™é‡Œçš„ `p1` å’Œ `p2` **éƒ½æ˜¯ `int\*` æŒ‡é’ˆ**ï¼Œå› ä¸º `typedef` **ç›´æ¥æ›¿æ¢ç±»å‹**ï¼Œä¸ä¼šå½±å“å˜é‡å®šä¹‰çš„æ–¹å¼ã€‚

**C++11 æ–°ç‰¹æ€§ï¼š`using`**

```cpp
using uint = unsigned int;  // ç­‰ä»·äº typedef unsigned int uint;
using IntPtr = int*;  // ç­‰ä»·äº typedef int* IntPtr;
```

ç›¸æ¯” `typedef`ï¼Œ`using` **å¯è¯»æ€§æ›´å¥½**ï¼Œå¹¶ä¸”å¯ä»¥ç”¨äº **æ¨¡æ¿åˆ«å**ï¼Œæ¨èåœ¨ C++ ä»£ç ä¸­ä½¿ç”¨ `using`ã€‚



#### inline

`inline` ç”¨äºä¿®é¥° **å‡½æ•°**ï¼Œå»ºè®®ç¼–è¯‘å™¨åœ¨è°ƒç”¨è¯¥å‡½æ•°æ—¶ **ç›´æ¥å±•å¼€ä»£ç **ï¼Œå‡å°‘å‡½æ•°è°ƒç”¨çš„å¼€é”€ã€‚

- å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€ï¼Œæé«˜æ•ˆç‡ï¼ˆé€‚ç”¨äº çŸ­å°å‡½æ•°ï¼‰ã€‚
- ç”±ç¼–è¯‘å™¨å†³å®šæ˜¯å¦çœŸæ­£å†…è”ï¼ˆä¸æ˜¯å¼ºåˆ¶çš„ï¼‰ã€‚
- é¿å… `#define` å®çš„ç¼ºç‚¹ï¼ˆæ”¯æŒç±»å‹æ£€æŸ¥ã€è°ƒè¯•ï¼‰ã€‚

```cpp
#include <iostream>
using namespace std;

inline int square(int x) {  // å»ºè®®ç¼–è¯‘å™¨å†…è”
    return x * x;
}

int main() {
    cout << "square(5): " << square(5) << endl;  // ç»“æœï¼š25
    return 0;
}
```

**ç­‰ä»·äº**

```cpp
cout << "square(5): " << (5 * 5) << endl;
```



### new malloc delete free





### constå’Œconstexpr

åœ¨ C++ ä¸­ï¼Œ`const` å’Œ `constexpr` éƒ½ç”¨äº **å£°æ˜å¸¸é‡**ï¼Œä½†å®ƒä»¬çš„ **ä½¿ç”¨åœºæ™¯å’Œç‰¹æ€§** æœ‰ä¸€äº›å…³é”®åŒºåˆ«ã€‚

#### const

`const` å…³é”®å­— **ç”¨äºå£°æ˜ä¸å¯ä¿®æ”¹çš„å˜é‡**ï¼Œä½†å®ƒçš„å€¼ **ä¸ä¸€å®šåœ¨ç¼–è¯‘æ—¶å·²çŸ¥**ï¼Œå¯ä»¥åœ¨ **è¿è¡Œæ—¶åˆå§‹åŒ–**ã€‚

- å˜é‡å£°æ˜å **ä¸å¯ä¿®æ”¹**ã€‚
- **å¯ä»¥åœ¨è¿è¡Œæ—¶åˆå§‹åŒ–**ï¼ˆä½†å¦‚æœæ˜¯å…¨å±€ `const`ï¼Œä»ç„¶éœ€è¦ç¼–è¯‘æ—¶åˆå§‹åŒ–ï¼‰ã€‚
- ä¸èƒ½ä½œä¸ºæ•°ç»„å¤§å°ï¼ˆé™¤éæ˜¯å…¨å±€æˆ–é™æ€ `const`ï¼‰ã€‚
- **é»˜è®¤æ˜¯å†…é“¾æ¥**ï¼ˆ`static` ä½œç”¨åŸŸï¼‰ã€‚

```cpp
#include <iostream>
using namespace std;

int getValue() {
    return 42;
}

int main() {
    int x = 10;
    const int a = 5;  // âœ… ç¼–è¯‘æ—¶å¯ç¡®å®šå€¼
    const int b = x;  // âœ… è¿è¡Œæ—¶ç¡®å®šå€¼
    // int arr[a];  // âœ… å¯ä»¥ç”¨ä½œæ•°ç»„å¤§å°
    // int arr[b];  // âŒ é”™è¯¯ï¼Œb ä¸æ˜¯ç¼–è¯‘æ—¶å¸¸é‡

    cout << "a: " << a << ", b: " << b << endl;
    return 0;
}
```

> **æ³¨æ„ï¼š** `const int b = x;` **å…è®¸ä½¿ç”¨** `x` çš„å€¼è¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œ `constexpr` ä¸èƒ½è¿™æ ·åšã€‚

------



#### constexpr

`constexpr` ç”¨äºå£°æ˜ **ç¼–è¯‘æœŸå¸¸é‡**ï¼Œ**å®ƒçš„å€¼å¿…é¡»åœ¨ç¼–è¯‘æ—¶å¯ç¡®å®š**ã€‚

- **å¿…é¡»åœ¨ç¼–è¯‘æ—¶åˆå§‹åŒ–**ï¼Œä¸èƒ½ä¾èµ–è¿è¡Œæ—¶è®¡ç®—çš„å€¼ã€‚
- **å¯ç”¨äºæ•°ç»„å¤§å°ã€æ¨¡æ¿å‚æ•°ç­‰** éœ€è¦ç¼–è¯‘æœŸå¸¸é‡çš„åœ°æ–¹ã€‚
- **è‡ªåŠ¨å†…è”ï¼ˆ`inline`ï¼‰**ï¼Œå¯ä»¥ç”¨äº **å‡½æ•°å’Œç±»æˆå‘˜**ã€‚
- **é€‚ç”¨äºç¼–è¯‘æœŸè®¡ç®—çš„åœºæ™¯**ï¼ˆå¦‚ `constexpr` å‡½æ•°ï¼‰ã€‚

```cpp
#include <iostream>
using namespace std;

constexpr int getConstValue() { return 10; }

int main() {
    constexpr int a = 5;   // âœ… ç¼–è¯‘æ—¶å¸¸é‡
    constexpr int b = getConstValue();  // âœ… å…è®¸ï¼Œè¿”å›å€¼æ˜¯ constexpr
    // int x = 10;
    // constexpr int c = x;  // âŒ é”™è¯¯ï¼Œx ä¸èƒ½ç”¨äº constexpr åˆå§‹åŒ–

    int arr[a];  // âœ… å¯ä»¥ç”¨ä½œæ•°ç»„å¤§å°
    cout << "a: " << a << ", b: " << b << endl;
    return 0;
}
```

> **æ³¨æ„ï¼š** `constexpr` å˜é‡çš„å€¼ **å¿…é¡»èƒ½åœ¨ç¼–è¯‘æ—¶ç¡®å®š**ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨è¿è¡Œæ—¶å˜é‡ `x` è¿›è¡Œåˆå§‹åŒ–ã€‚



#### constexprå‡½æ•°

C++11 å¼•å…¥äº† `constexpr` **å‡½æ•°**ï¼Œå¯ä»¥åœ¨ç¼–è¯‘æœŸ **è¿›è¡Œè®¡ç®—**ã€‚

```cpp
#include <iostream>
using namespace std;

constexpr int square(int x) { return x * x; }

int main() {
    constexpr int result = square(5);  // âœ… è®¡ç®—åœ¨ç¼–è¯‘æœŸå®Œæˆ
    int x = 10;
    int runtime_result = square(x);  // âœ… è¿è¡Œæ—¶è®¡ç®—
    cout << "result: " << result << ", runtime_result: " << runtime_result << endl;
    return 0;
}
```

> **æ³¨æ„ï¼š** `constexpr` å‡½æ•°åœ¨ç¼–è¯‘æ—¶å¯ä»¥è¢«è®¡ç®—ï¼Œ**ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶ä½¿ç”¨**ï¼ˆå¦‚æœä¼ å…¥çš„å‚æ•°æ˜¯è¿è¡Œæ—¶å˜é‡ï¼‰ã€‚

------



#### constå’Œ constexprç»“åˆ

å¯ä»¥å°† `constexpr` **è¿”å›çš„å€¼èµ‹ç»™ `const` å˜é‡**ï¼š

```cpp
constexpr int getVal() { return 100; }

int main() {
    const int a = getVal();  // âœ… å…è®¸
    constexpr int b = getVal();  // âœ… å…è®¸
}
```

ä½†å¦‚æœ `getVal()` **ä¸æ˜¯ `constexpr` å‡½æ•°**ï¼Œé‚£ä¹ˆ `constexpr int b = getVal();` **ä¼šæŠ¥é”™**ã€‚



#### æ€»ç»“

- `const` å˜é‡åœ¨ è¿è¡Œæ—¶åˆå§‹åŒ–ï¼Œä¸èƒ½ä¿®æ”¹ï¼Œä½†å¯ä»¥ä¾èµ–è¿è¡Œæ—¶å˜é‡ã€‚
- `constexpr` å˜é‡å¿…é¡»åœ¨ç¼–è¯‘æ—¶åˆå§‹åŒ–ï¼Œé€‚ç”¨äº æ•°ç»„å¤§å°ã€æ¨¡æ¿å‚æ•°ã€ç¼–è¯‘æœŸä¼˜åŒ–ã€‚
- `constexpr` å‡½æ•° å¯ä»¥ åœ¨ç¼–è¯‘æ—¶è®¡ç®—ï¼Œä¹Ÿå¯ä»¥ åœ¨è¿è¡Œæ—¶ä½¿ç”¨ã€‚
- `constexpr` æ›´å¼ºå¤§ï¼Œä½†ä½¿ç”¨æ—¶è¦ç¡®ä¿å€¼å¯åœ¨ç¼–è¯‘æœŸç¡®å®šã€‚



### å‰ç½®++ä¸åç½®++

- å‰ç½® `++`ï¼ˆ`++obj`ï¼‰ï¼šè¿”å›è‡ªå¢åçš„å¯¹è±¡ã€‚
- åç½® `++`ï¼ˆ`obj++`ï¼‰ï¼šéœ€è¦ä¸€ä¸ª int å½¢å‚ä½œä¸ºåŒºåˆ†ï¼Œå¹¶è¿”å›è‡ªå¢å‰çš„å¯¹è±¡ã€‚

```cpp
#include <iostream>

class Counter {
private:
    int value;
public:
    Counter(int v) : value(v) {}

    // å‰ç½®++ (prefix increment)
    Counter& operator++() {
        ++value;    // å…ˆè‡ªå¢
        return *this; // è¿”å›è‡ªå¢åçš„å¯¹è±¡ï¼ˆå¼•ç”¨ï¼‰
    }

    // åç½®++ (postfix increment)
    const Counter operator++(int) { // æ³¨æ„è¿™é‡Œçš„ int å‚æ•°
        Counter temp = *this; // å…ˆä¿å­˜å½“å‰çŠ¶æ€
        ++value;   // è‡ªå¢
        return temp; // è¿”å›åŸå§‹å€¼
    }

    void print() const {
        std::cout << "Value: " << value << std::endl;
    }
};

int main() {
    Counter c(5);

    ++c;   // è°ƒç”¨å‰ç½®++
    c.print(); // Value: 6

    c++;   // è°ƒç”¨åç½®++
    c.print(); // Value: 7

    return 0;
}
```

 1ã€ä¸ºä»€ä¹ˆåç½®è¿”å›å¯¹è±¡ï¼Œâ½½ä¸æ˜¯å¼•â½¤ 

å› ä¸ºåç½®ä¸ºäº†è¿”å›æ—§å€¼åˆ›å»ºäº†â¼€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œåœ¨å‡½æ•°ç»“æŸçš„æ—¶å€™è¿™ä¸ªå¯¹è±¡å°±ä¼šè¢«é”€æ¯ï¼Œå¦‚æœè¿”å›å¼•â½¤ï¼Œé‚£ä¹ˆæˆ‘è¯·é—® ä½ ï¼Ÿä½ çš„å¯¹è±¡å¯¹è±¡éƒ½è¢«é”€æ¯äº†ï¼Œä½ å¼•â½¤å•¥å‘¢ï¼Ÿ 

2ã€ä¸ºä»€ä¹ˆåç½®å‰â¾¯ä¹Ÿè¦åŠ const 

å…¶å®ä¹Ÿå¯ä»¥ä¸åŠ ï¼Œä½†æ˜¯ä¸ºäº†é˜²â½Œä½ ä½¿â½¤i++++,è¿ç»­ä¸¤æ¬¡çš„è°ƒâ½¤åç½®++é‡è½½ç¬¦ï¼Œä¸ºä»€ä¹ˆå‘¢? åŸå› ï¼š å®ƒä¸å†…ç½®ç±»å‹â¾ä¸ºä¸â¼€è‡´ï¼›ä½ â½†æ³•æ´»å¾—ä½ æ‰€æœŸæœ›çš„ç»“æœï¼Œå› ä¸ºç¬¬â¼€æ¬¡è¿”å›çš„æ˜¯æ—§å€¼ï¼Œâ½½ä¸æ˜¯åŸå¯¹è±¡ï¼Œä½ è°ƒâ½¤ä¸¤æ¬¡å ç½®++ï¼Œç»“æœåªç´¯åŠ äº†â¼€æ¬¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»â¼¿åŠ¨ç¦â½Œå…¶åˆæ³•åŒ–ï¼Œå°±è¦åœ¨å‰â¾¯åŠ ä¸Šconstã€‚ 

3ã€å¤„ç†â½¤æˆ·çš„â¾ƒå®šä¹‰ç±»å‹ æœ€å¥½ä½¿â½¤å‰ç½®++ï¼Œå› ä¸ºä»–ä¸ä¼šåˆ›å»ºä¸´æ—¶å¯¹è±¡ï¼Œè¿›â½½ä¸ä¼šå¸¦æ¥æ„é€ å’Œææ„â½½é€ æˆçš„æ ¼å¤–å¼€é”€ã€‚



### å‡½æ•°æŒ‡é’ˆ

```cpp
#include <iostream>

// å®šä¹‰ä¸€ä¸ªæ™®é€šå‡½æ•°
int add(int a, int b) {
    return a + b;
}

int main() {
    // å£°æ˜å‡½æ•°æŒ‡é’ˆï¼ˆæŒ‡å‘è¿”å›å€¼ä¸º intï¼Œå‚æ•°ä¸º (int, int) çš„å‡½æ•°ï¼‰
    int (*funcPtr)(int, int);

    // èµ‹å€¼ï¼ˆå°† add å‡½æ•°çš„åœ°å€èµ‹ç»™ funcPtrï¼‰
    funcPtr = add;

    // é€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨å‡½æ•°
    std::cout << "Result: " << funcPtr(3, 5) << std::endl;  // è¾“å‡º 8

    return 0;
}

```

#### è¦ç‚¹

1. **å‡½æ•°æŒ‡é’ˆçš„å£°æ˜æ ¼å¼**ï¼š

   ```cpp
   è¿”å›ç±»å‹ (*æŒ‡é’ˆå˜é‡å)(å‚æ•°ç±»å‹);
   ```

   ä¾‹å¦‚ï¼š`int (*funcPtr)(int, int);`

2. **èµ‹å€¼æ—¶å¯ä»¥çœç•¥ `&`**ï¼Œå³ `funcPtr = add;` ç­‰ä»·äº `funcPtr = &add;`

3. **è°ƒç”¨æ–¹å¼**ï¼š

   - `funcPtr(3, 5);`  âœ…ï¼ˆæ¨èï¼‰
   - `(*funcPtr)(3, 5);`  âœ…ï¼ˆç­‰ä»·ï¼‰



#### åº”ç”¨

**ï¼ˆ1ï¼‰å‡½æ•°æŒ‡é’ˆä½œä¸ºå‚æ•°ï¼ˆå›è°ƒå‡½æ•°ï¼‰**

å‡½æ•°æŒ‡é’ˆå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œä½¿å‡½æ•°çš„è¡Œä¸ºæ›´åŠ çµæ´»ã€‚

```cpp
#include <iostream>

// å®šä¹‰ä¸¤ä¸ªè¿ç®—å‡½æ•°
int add(int a, int b) { return a + b; }
int multiply(int a, int b) { return a * b; }

// è®¡ç®—å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆä½œä¸ºå‚æ•°
int calculate(int x, int y, int (*operation)(int, int)) {
    return operation(x, y);  // è°ƒç”¨ä¼ å…¥çš„å‡½æ•°
}

int main() {
    std::cout << "Add: " << calculate(4, 5, add) << std::endl;         // 9
    std::cout << "Multiply: " << calculate(4, 5, multiply) << std::endl; // 20
    return 0;
}
```

ğŸ“Œ **ä¼˜ç‚¹**ï¼š

- **`calculate`** å‡½æ•°å¯ä»¥ä½¿ç”¨ä¸åŒçš„è¿ç®—å‡½æ•°ï¼Œæé«˜ä»£ç å¤ç”¨æ€§ã€‚
- **å›è°ƒå‡½æ•°**ï¼šé€‚ç”¨äºæ’åºã€è‡ªå®šä¹‰æ“ä½œç­‰åœºæ™¯ã€‚

------

**ï¼ˆ2ï¼‰æ•°ç»„ + å‡½æ•°æŒ‡é’ˆï¼ˆå‡½æ•°è¡¨/è·³è½¬è¡¨ï¼‰**

å¯ä»¥ç”¨å‡½æ•°æŒ‡é’ˆæ•°ç»„åˆ›å»º**å‡½æ•°è¡¨**ï¼Œè®©ç¨‹åºåŠ¨æ€é€‰æ‹©è¦æ‰§è¡Œçš„å‡½æ•°ã€‚

```cpp
include <iostream>

// å®šä¹‰ä¸‰ä¸ªæ“ä½œå‡½æ•°
int add(int a, int b) { return a + b; }
int subtract(int a, int b) { return a - b; }
int multiply(int a, int b) { return a * b; }

int main() {
    // å‡½æ•°æŒ‡é’ˆæ•°ç»„
    int (*operations[])(int, int) = {add, subtract, multiply};

    // é€‰æ‹©è¿ç®—æ–¹å¼
    int choice = 2;  // 0 = add, 1 = subtract, 2 = multiply

    std::cout << "Result: " << operations[choice](10, 5) << std::endl;  // 50 (è°ƒç”¨ multiply)
    
    return 0;
}
```

ğŸ“Œ **ä¼˜åŠ¿**ï¼š

- **ç±»ä¼¼ `switch` è¯­å¥ï¼Œä½†æ›´çµæ´»**ï¼Œå¯ä»¥åŠ¨æ€æ‰©å±•ã€‚
- **å¸¸ç”¨äºå‘½ä»¤è§£æã€èœå•ç³»ç»Ÿã€äº‹ä»¶å›è°ƒç­‰**ã€‚

------

**ï¼ˆ3ï¼‰æŒ‡å‘æˆå‘˜å‡½æ•°çš„æŒ‡é’ˆ**

C++ å…è®¸å‡½æ•°æŒ‡é’ˆæŒ‡å‘**ç±»çš„æˆå‘˜å‡½æ•°**ï¼Œä½†**æˆå‘˜å‡½æ•°æŒ‡é’ˆçš„è¯­æ³•ä¸åŒ**ï¼š

```cpp
#include <iostream>

class Calculator {
public:
    int add(int a, int b) { return a + b; }
};

int main() {
    Calculator obj;
    
    // å®šä¹‰æˆå‘˜å‡½æ•°æŒ‡é’ˆ
    int (Calculator::*funcPtr)(int, int) = &Calculator::add;

    // é€šè¿‡å¯¹è±¡è°ƒç”¨æˆå‘˜å‡½æ•°æŒ‡é’ˆ
    std::cout << "Result: " << (obj.*funcPtr)(3, 7) << std::endl;  // 10
    
    // é€šè¿‡æŒ‡é’ˆè°ƒç”¨
    Calculator* pObj = &obj;
    std::cout << "Result: " << (pObj->*funcPtr)(3, 7) << std::endl;  // 10

    return 0;
}
```

ğŸ“Œ **è¦ç‚¹**ï¼š

- **æˆå‘˜å‡½æ•°æŒ‡é’ˆçš„å®šä¹‰**ï¼š

  ```cpp
  è¿”å›ç±»å‹ (ç±»å::*æŒ‡é’ˆå˜é‡)(å‚æ•°åˆ—è¡¨) = &ç±»å::æˆå‘˜å‡½æ•°;
  ```

- **è°ƒç”¨æ–¹å¼**ï¼š

  - `å¯¹è±¡.*æŒ‡é’ˆ(å‚æ•°);`
  - `å¯¹è±¡æŒ‡é’ˆ->*æŒ‡é’ˆ(å‚æ•°);`
  - **è°ƒç”¨æˆå‘˜å‡½æ•°æŒ‡é’ˆæ—¶ï¼Œ`.\*` å’Œ `->\*` æ˜¯å¿…é¡»çš„**ï¼Œä¸èƒ½çœç•¥ `*` å·

------

**ï¼ˆ4ï¼‰ä½¿ç”¨ `std::function` ä»£æ›¿å‡½æ•°æŒ‡é’ˆï¼ˆC++11+ï¼‰**

C++11 æä¾›äº† `std::function`ï¼Œå¯ä»¥å­˜å‚¨æ™®é€šå‡½æ•°ã€lambdaã€æˆå‘˜å‡½æ•°ç­‰ï¼Œå¯è¯»æ€§æ›´å¥½ã€‚

```cpp
#include <iostream>
#include <functional>  // å¼•å…¥ std::function

int add(int a, int b) { return a + b; }

int main() {
    std::function<int(int, int)> funcPtr = add;
    
    std::cout << "Result: " << funcPtr(4, 6) << std::endl;  // 10
    return 0;
}
```

ğŸ“Œ **ä¼˜åŠ¿**ï¼š

- å¯ä»¥å­˜å‚¨**æ™®é€šå‡½æ•°ã€lambda è¡¨è¾¾å¼ã€æˆå‘˜å‡½æ•°**ç­‰ã€‚
- æ›´åŠ **çµæ´»å’Œå®‰å…¨**ï¼Œé¿å…å‡½æ•°æŒ‡é’ˆçš„å¤æ‚è¯­æ³•ã€‚



### å¼ºåˆ¶ç±»å‹è½¬æ¢

åœ¨ C++ ä¸­ï¼Œæä¾›äº† 4 ç§ç±»å‹è½¬æ¢å…³é”®å­—ï¼Œåˆ†åˆ«æ˜¯ `static_cast`ã€`dynamic_cast`ã€`reinterpret_cast` å’Œ `const_cast`ã€‚ç›¸æ¯” C è¯­è¨€çš„å¼ºåˆ¶è½¬æ¢ï¼ˆ`(type)value`ï¼‰ï¼ŒC++ çš„è¿™ 4 ç§è½¬æ¢æ–¹å¼æä¾›äº†æ›´å¼ºçš„**ç±»å‹å®‰å…¨æ€§**å’Œ**å¯è¯»æ€§**ã€‚



#### 1. `static_cast`ï¼ˆé™æ€è½¬æ¢ï¼‰

`static_cast` ä¸»è¦ç”¨äº**ç¼–è¯‘æœŸå¯ä»¥ç¡®å®šçš„è½¬æ¢**ï¼Œæ¯”å¦‚åŸºæœ¬ç±»å‹è½¬æ¢ã€çˆ¶å­ç±»æŒ‡é’ˆè½¬æ¢ï¼ˆéè™šå‡½æ•°çš„æƒ…å†µï¼‰ã€‚

âœ… **åŸºæœ¬æ•°æ®ç±»å‹è½¬æ¢** âœ… **å­ç±»æŒ‡é’ˆ â†’ çˆ¶ç±»æŒ‡é’ˆ** âœ… **çˆ¶ç±»æŒ‡é’ˆ â†’ å­ç±»æŒ‡é’ˆï¼ˆä¸å®‰å…¨ï¼Œéœ€å¼€å‘è€…ä¿è¯æ­£ç¡®æ€§ï¼‰** âœ… **void\* æŒ‡é’ˆè½¬æ¢ä¸ºå…·ä½“ç±»å‹æŒ‡é’ˆ**

```cpp
#include <iostream>

class Base {};
class Derived : public Base {};

int main() {
    // åŸºæœ¬ç±»å‹è½¬æ¢
    double d = 3.14;
    int i = static_cast<int>(d);  // âœ… è½¬æ¢ double â†’ int
    std::cout << "i = " << i << std::endl;

    // å­ç±»æŒ‡é’ˆè½¬æ¢ä¸ºçˆ¶ç±»æŒ‡é’ˆï¼ˆå®‰å…¨ï¼‰
    Derived dObj;
    Base* basePtr = static_cast<Base*>(&dObj);  // âœ… å­ç±» â†’ çˆ¶ç±»

    // çˆ¶ç±»æŒ‡é’ˆè½¬æ¢ä¸ºå­ç±»æŒ‡é’ˆï¼ˆä¸å®‰å…¨ï¼Œéœ€ä¿è¯æ˜¯æ­£ç¡®çš„å­ç±»å¯¹è±¡ï¼‰
    Base* bPtr = new Derived();
    Derived* dPtr = static_cast<Derived*>(bPtr);  // â—ä¸æ£€æŸ¥å®‰å…¨æ€§ï¼Œéœ€å¼€å‘è€…ä¿è¯ bPtr æŒ‡å‘ Derived

    return 0;
}
```

ğŸ“Œ **æ³¨æ„**ï¼š

- `static_cast` **ä¸ä¼šæ‰§è¡Œè¿è¡Œæ—¶æ£€æŸ¥**ï¼Œå¦‚æœ `bPtr` æŒ‡å‘çš„å¯¹è±¡ä¸æ˜¯ `Derived`ï¼Œè½¬æ¢ä¼šå¯¼è‡´**æœªå®šä¹‰è¡Œä¸º**ï¼ˆUBï¼‰ã€‚
- ä¸èƒ½ç”¨äºä¸åŒç±»å‹å¯¹è±¡ä¹‹é—´çš„è½¬æ¢ï¼Œæ¯”å¦‚ `Base` â†’ `int`ï¼Œè¿™ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚



#### 2. `dynamic_cast`ï¼ˆåŠ¨æ€è½¬æ¢ï¼‰

`dynamic_cast` ä¸»è¦ç”¨äº**å«æœ‰è™šå‡½æ•°çš„å¤šæ€ç±»ä¹‹é—´çš„å®‰å…¨è½¬æ¢**ï¼Œä¾èµ– **RTTIï¼ˆè¿è¡Œæ—¶ç±»å‹è¯†åˆ«ï¼‰**ã€‚

âœ… **çˆ¶ç±»æŒ‡é’ˆï¼ˆæˆ–å¼•ç”¨ï¼‰ â†’ å­ç±»æŒ‡é’ˆï¼ˆæˆ–å¼•ç”¨ï¼‰** âœ… **å¿…é¡»æ˜¯å¤šæ€ç±»ï¼ˆåŸºç±»è¦æœ‰è™šå‡½æ•°ï¼‰** âœ… **è½¬æ¢å¤±è´¥æ—¶ï¼ŒæŒ‡é’ˆè¿”å› `nullptr`ï¼Œå¼•ç”¨æŠ› `std::bad_cast` å¼‚å¸¸**

```cpp
#include <iostream>
#include <typeinfo>

class Base {
public:
    virtual void show() {}  // å¿…é¡»æœ‰è™šå‡½æ•°ï¼Œä¿è¯æ˜¯å¤šæ€ç±»
};

class Derived : public Base {};

class OtherClass {};

int main() {
    Base* basePtr = new Derived();
    Derived* derivedPtr = dynamic_cast<Derived*>(basePtr);  // âœ… å®‰å…¨è½¬æ¢

    if (derivedPtr) {
        std::cout << "Conversion successful!" << std::endl;
    } else {
        std::cout << "Conversion failed!" << std::endl;
    }

    // é”™è¯¯è½¬æ¢ï¼ˆè½¬æ¢å¤±è´¥ï¼Œè¿”å› nullptrï¼‰
    Base* basePtr2 = new Base();
    Derived* derivedPtr2 = dynamic_cast<Derived*>(basePtr2);  // âŒ å¤±è´¥ï¼ŒbasePtr2 æŒ‡å‘çš„æ˜¯ Base
    if (!derivedPtr2) {
        std::cout << "Conversion failed!" << std::endl;
    }

    return 0;
}
```

ğŸ“Œ **æ³¨æ„**ï¼š

- `Base` å¿…é¡»æ˜¯**å¤šæ€ç±»**ï¼ˆæœ‰è‡³å°‘ä¸€ä¸ª `virtual` å‡½æ•°ï¼‰ã€‚

- ```
  dynamic_cast
  ```

  æœ‰è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ï¼Œå¦‚æœè½¬æ¢å¤±è´¥ï¼š

  - **æŒ‡é’ˆ** è¿”å› `nullptr`
  - **å¼•ç”¨** æŠ› `std::bad_cast` å¼‚å¸¸

- æ¯” `static_cast` **æ›´å®‰å…¨ï¼Œä½†æœ‰æ€§èƒ½æŸè€—**ï¼Œå› ä¸ºå®ƒä¾èµ– RTTIã€‚



#### 3. `reinterpret_cast`ï¼ˆé‡æ–°è§£é‡Šè½¬æ¢ï¼‰

`reinterpret_cast` ç”¨äº**å‡ ä¹ä»»æ„ç±»å‹ä¹‹é—´çš„è½¬æ¢**ï¼Œä¸ä¼šæ£€æŸ¥å®‰å…¨æ€§ã€‚

âœ… **æŒ‡é’ˆç±»å‹é—´è½¬æ¢ï¼ˆå¦‚ `int\*` â†” `char\*`ï¼‰** âœ… **æ•´æ•° â†” æŒ‡é’ˆ** âœ… **å‡½æ•°æŒ‡é’ˆè½¬æ¢** âŒ **ä¸è¦ç”¨äºç±»å±‚æ¬¡ç»“æ„ä¹‹é—´çš„è½¬æ¢ï¼ˆ`Base` â†” `Derived`ï¼‰ï¼Œå¯èƒ½å¯¼è‡´ UB**

```cpp
#include <iostream>

int main() {
    int a = 65;
    char* c = reinterpret_cast<char*>(&a);  // âœ… int* â†’ char*
    std::cout << "Char value: " << *c << std::endl;  // å¯èƒ½è¾“å‡º 'A'ï¼ˆASCII 65ï¼‰

    // int è½¬æŒ‡é’ˆ
    int* ptr = reinterpret_cast<int*>(0x12345678);
    std::cout << "ptr: " << ptr << std::endl;  // å¯èƒ½å¯¼è‡´ UB

    return 0;
}
```

ğŸ“Œ **æ³¨æ„**ï¼š

- `reinterpret_cast` **ä¸ä¼šè¿›è¡Œç±»å‹æ£€æŸ¥**ï¼Œå®Œå…¨æ˜¯**äºŒè¿›åˆ¶çº§åˆ«**çš„è½¬æ¢ã€‚
- å¯èƒ½å¯¼è‡´**æœªå®šä¹‰è¡Œä¸ºï¼ˆUBï¼‰**ï¼Œéœ€å¼€å‘è€…ç¡®ä¿åˆç†ä½¿ç”¨ã€‚



#### 4. `const_cast`ï¼ˆå»é™¤ `const` é™å®šï¼‰

`const_cast` ä¸»è¦ç”¨äº**å»é™¤ `const` æˆ– `volatile` ä¿®é¥°**ï¼Œä½¿å¾—å¯ä¿®æ”¹å¸¸é‡ã€‚

âœ… **å»é™¤ `const`ï¼Œè®©åŸæœ¬ `const` å¯¹è±¡å¯ä¿®æ”¹** âœ… ==**å¸¸ç”¨äºéœ€è¦ä¿®æ”¹ `const` å‚æ•°çš„æ—§ API**== âŒ **ä¸èƒ½ç”¨äº `const` å˜é‡çš„ç›´æ¥ä¿®æ”¹ï¼Œå¦åˆ™ UB**

```cpp
#include <iostream>

void modify(const int* ptr) {
    int* modifiable = const_cast<int*>(ptr);  // âœ… å»æ‰ const
    *modifiable = 100;
}

int main() {
    int x = 10;
    modify(&x);
    std::cout << "Modified x: " << x << std::endl;  // âœ… è¾“å‡º 100

    // âŒ é”™è¯¯ç”¨æ³•ï¼ˆä¿®æ”¹çœŸæ­£çš„å¸¸é‡ï¼ŒUBï¼‰
    const int y = 20;
    int* p = const_cast<int*>(&y);
    *p = 30;  // âŒ UBï¼Œä¸è¦ä¿®æ”¹ const å˜é‡

    return 0;
}
```

ğŸ“Œ **æ³¨æ„**ï¼š

- `const_cast` **åªèƒ½ç§»é™¤ `const`ï¼Œä¸èƒ½ç”¨äºç±»å‹è½¬æ¢**ã€‚
- **å¦‚æœ `const` å˜é‡å­˜æ”¾åœ¨åªè¯»å†…å­˜åŒºï¼Œä¿®æ”¹å®ƒå¯èƒ½ä¼šå¯¼è‡´å´©æºƒï¼ˆUBï¼‰**ã€‚



#### 5. æ€»ç»“

| ç±»å‹               | ç”¨é€”                       | è¿è¡Œæ—¶æ£€æŸ¥ | å®‰å…¨æ€§     | å…¸å‹ç”¨æ³•                                   |
| ------------------ | -------------------------- | ---------- | ---------- | ------------------------------------------ |
| `static_cast`      | ç¼–è¯‘æœŸå¯ç¡®å®šçš„è½¬æ¢         | âŒ æ—        | âš ï¸ ç›¸å¯¹å®‰å…¨ | åŸºæœ¬ç±»å‹ã€çˆ¶å­ç±»æŒ‡é’ˆè½¬æ¢                   |
| `dynamic_cast`     | å¤šæ€ç±»å‹è½¬æ¢               | âœ… æœ‰       | âœ… é«˜å®‰å…¨æ€§ | è¿è¡Œæ—¶æ£€æŸ¥ RTTIï¼Œå®‰å…¨è½¬æ¢çˆ¶ç±» â†” å­ç±»       |
| `reinterpret_cast` | ä»»æ„ç±»å‹è½¬æ¢               | âŒ æ—        | âŒ ä¸å®‰å…¨   | æŒ‡é’ˆç±»å‹ã€æ•´æ•° â†” æŒ‡é’ˆã€å‡½æ•°æŒ‡é’ˆè½¬æ¢        |
| `const_cast`       | ç§»é™¤ `const/volatile` ä¿®é¥° | âŒ æ—        | âš ï¸ å¯èƒ½ UB  | ä¿®æ”¹ `const` å˜é‡ï¼ˆä»…ç”¨äºé `const` å˜é‡ï¼‰ |

ğŸ“Œ **æœ€ä½³å®è·µ**

- âœ… **ä¼˜å…ˆä½¿ç”¨ `static_cast`ï¼Œé¿å… `reinterpret_cast`**
- âœ… **å¤šæ€ç±»å‹è½¬æ¢åº”ä½¿ç”¨ `dynamic_cast`**
- âœ… **å°½é‡é¿å… `const_cast` ä¿®æ”¹ `const` å˜é‡**

è¿™ 4 ç§è½¬æ¢æ–¹å¼æ¯” C é£æ ¼çš„ `(T)value` æ›´å®‰å…¨ã€å¯è¯»æ€§æ›´å¥½ï¼Œèƒ½å¸®åŠ©å¼€å‘è€…æ›´æ¸…æ™°åœ°ç®¡ç†ç±»å‹è½¬æ¢ï¼



### cppå†…å­˜ç®¡ç†

C++ å†…å­˜å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªåŒºåŸŸï¼š

| **å†…å­˜åŒºåŸŸ**                    | **ç‰¹ç‚¹**             | **å…¸å‹å†…å®¹**                                                 |
| ------------------------------- | -------------------- | ------------------------------------------------------------ |
| **æ ˆï¼ˆStackï¼‰**                 | ç”±ç³»ç»Ÿè‡ªåŠ¨åˆ†é…å’Œé‡Šæ”¾ | ==å±€éƒ¨å˜é‡ã€å‡½æ•°å‚æ•°ã€è¿”å›åœ°å€==                             |
| **å †ï¼ˆHeapï¼‰**                  | ç”±ç¨‹åºå‘˜åˆ†é…å’Œé‡Šæ”¾   | `new`/`malloc` åˆ›å»ºçš„åŠ¨æ€å¯¹è±¡ï¼Œç¨‹åºå‘˜æ‰‹åŠ¨åˆ†é…å’Œé‡Šæ”¾          |
| **é™æ€å­˜å‚¨åŒºï¼ˆStatic/Globalï¼‰** | ç¨‹åºå¼€å§‹åˆ°ç»“æŸ       | `static` å˜é‡ã€å…¨å±€å˜é‡ã€å¸¸é‡å­—ç¬¦ä¸²ï¼Œç¨‹åºè¿è¡ŒæœŸé—´ä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°ç¨‹åºç»“æŸã€‚**è‡ªåŠ¨åˆå§‹åŒ–**ï¼Œå…¨å±€å˜é‡å’Œ `static` å˜é‡é»˜è®¤åˆå§‹åŒ–ä¸º 0ã€‚ |
| **ä»£ç æ®µï¼ˆCode Segmentï¼‰**      | åªè¯»ã€å­˜æ”¾å¯æ‰§è¡Œä»£ç  | å¯æ‰§è¡Œç¨‹åºæŒ‡ä»¤ï¼Œ**åªè¯»**ï¼Œé˜²æ­¢ç¨‹åºæ„å¤–ä¿®æ”¹ä»£ç                |



### æ™ºèƒ½æŒ‡é’ˆ

æ™ºèƒ½æŒ‡é’ˆï¼ˆSmart Pointerï¼‰æ˜¯ C++ æ ‡å‡†åº“æä¾›çš„ **è‡ªåŠ¨ç®¡ç†å†…å­˜** çš„æŒ‡é’ˆå¯¹è±¡ï¼Œèƒ½å¤Ÿåœ¨ä¸éœ€è¦æ—¶ **è‡ªåŠ¨é‡Šæ”¾å†…å­˜**ï¼Œä»è€Œé˜²æ­¢å†…å­˜æ³„æ¼å’Œæ‚¬æµ®æŒ‡é’ˆé—®é¢˜ã€‚

C++ æ ‡å‡†åº“æä¾›äº† ä¸‰ç§ä¸»è¦çš„æ™ºèƒ½æŒ‡é’ˆï¼ˆä½äº `<memory>` å¤´æ–‡ä»¶ä¸­ï¼‰ï¼š

- `std::unique_ptr`ï¼ˆç‹¬å æ‰€æœ‰æƒï¼‰
- `std::shared_ptr`ï¼ˆå¼•ç”¨è®¡æ•°å…±äº«ï¼‰
- `std::weak_ptr`ï¼ˆå¼±å¼•ç”¨ï¼Œé¿å…å¾ªç¯å¼•ç”¨ï¼‰



#### `std::unique_ptr`ï¼ˆç‹¬å æ‰€æœ‰æƒï¼‰

- **ç‰¹ç‚¹**
  - **å”¯ä¸€æ‰€æœ‰æƒ**ï¼š`unique_ptr` åªèƒ½æœ‰ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆç®¡ç†åŒä¸€ä¸ªå¯¹è±¡ï¼Œä¸èƒ½å…±äº«ã€‚
  - **è‡ªåŠ¨é‡Šæ”¾**ï¼š`unique_ptr` åœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾å†…å­˜ã€‚
  - **ä¸å¯å¤åˆ¶**ï¼Œä½†**å¯ä»¥ç§»åŠ¨**ï¼ˆ`std::move`ï¼‰ã€‚
- **ç¤ºä¾‹**

```cpp
#include <iostream>
#include <memory>

class Test {
public:
    Test() { std::cout << "Constructor\n"; }
    ~Test() { std::cout << "Destructor\n"; }
};

int main() {
    std::unique_ptr<Test> ptr1 = std::make_unique<Test>();  // âœ… åˆ›å»ºå¯¹è±¡
    // std::unique_ptr<Test> ptr2 = ptr1;  âŒ é”™è¯¯ï¼Œunique_ptr ä¸èƒ½å¤åˆ¶

    std::unique_ptr<Test> ptr2 = std::move(ptr1);  // âœ… è½¬ç§»æ‰€æœ‰æƒ
    if (!ptr1) std::cout << "ptr1 is now nullptr\n";

    return 0;
}  // âœ… ptr2 ç¦»å¼€ä½œç”¨åŸŸï¼Œè‡ªåŠ¨é‡Šæ”¾å¯¹è±¡
```

- `std::make_unique<T>()` æ¨èç”¨æ³•

  - `std::make_unique<T>()` **æ¯” `new` æ›´å®‰å…¨**ï¼Œå¯ä»¥é˜²æ­¢å¼‚å¸¸æ—¶çš„å†…å­˜æ³„æ¼ï¼š

  ```cpp
  std::unique_ptr<int> p = std::make_unique<int>(10);  // âœ… æ¨è
  ```

  è€Œ 

  ```
  std::unique_ptr<int> p(new int(10));
  ```

   å¯èƒ½å¯¼è‡´å¼‚å¸¸æ—¶å†…å­˜æ³„æ¼ã€‚



####  `std::shared_ptr`ï¼ˆå¼•ç”¨è®¡æ•°å…±äº«ï¼‰

- **ç‰¹ç‚¹**
  - **å¤šä¸ª `shared_ptr` å¯ä»¥å…±äº«åŒä¸€å¯¹è±¡**ï¼Œä½¿ç”¨**å¼•ç”¨è®¡æ•°**ï¼ˆReference Countingï¼‰ã€‚
  - **å½“æœ€åä¸€ä¸ª `shared_ptr` ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œè‡ªåŠ¨é‡Šæ”¾å¯¹è±¡**ã€‚
  - **é€‚ç”¨äºå¤šä¸ªå¯¹è±¡å…±äº«èµ„æºçš„æƒ…å†µ**ã€‚
- **ç¤ºä¾‹**

```cpp
#include <iostream>
#include <memory>

class Test {
public:
    Test() { std::cout << "Constructor\n"; }
    ~Test() { std::cout << "Destructor\n"; }
};

int main() {
    std::shared_ptr<Test> ptr1 = std::make_shared<Test>();  // âœ… å…±äº«æ‰€æœ‰æƒ
    std::shared_ptr<Test> ptr2 = ptr1;  // âœ… å¼•ç”¨è®¡æ•° +1

    std::cout << "Reference count: " << ptr1.use_count() << "\n";  // è¾“å‡º 2
    ptr1.reset();  // âœ… é‡Šæ”¾ ptr1ï¼Œå¼•ç”¨è®¡æ•° -1
    std::cout << "Reference count: " << ptr2.use_count() << "\n";  // è¾“å‡º 1

    return 0;
}  // âœ… ptr2 ç¦»å¼€ä½œç”¨åŸŸï¼Œå¼•ç”¨è®¡æ•°å˜ 0ï¼Œé‡Šæ”¾å¯¹è±¡
```

- `std::make_shared<T>()` æ¨èç”¨æ³•

  ```cpp
  std::shared_ptr<int> p = std::make_shared<int>(10);  // âœ… æ¨è
  ```

  ```
  std::make_shared<T>()
  ```

  å‡å°‘äº†é¢å¤–çš„å†…å­˜åˆ†é…ï¼Œæ¯” 

  ```
  new
  ```

   æ›´é«˜æ•ˆã€‚



#### `std::weak_ptr`ï¼ˆå¼±å¼•ç”¨ï¼Œé¿å…å¾ªç¯å¼•ç”¨ï¼‰

- **ç‰¹ç‚¹**
  - `weak_ptr` **ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°**ï¼Œåªå¯¹ `shared_ptr` è¿›è¡Œ**éæ‹¥æœ‰æ€§å¼•ç”¨**ã€‚
  - **ç”¨äºé¿å… `shared_ptr` å¾ªç¯å¼•ç”¨**ï¼ˆæ¯”å¦‚ `std::shared_ptr<A>` å’Œ `std::shared_ptr<B>` äº’ç›¸æŒæœ‰å¯¹æ–¹ï¼‰ã€‚
  - `weak_ptr` **ä¸èƒ½ç›´æ¥ä½¿ç”¨**ï¼Œéœ€è¦ä½¿ç”¨ `.lock()` è½¬æ¢ä¸º `shared_ptr`ã€‚
- **ç¤ºä¾‹ï¼ˆé¿å…å¾ªç¯å¼•ç”¨ï¼‰**

```cpp
#include <iostream>
#include <memory>

class B;  // å‰å‘å£°æ˜

class A {
public:
    std::shared_ptr<B> b_ptr;
    ~A() { std::cout << "A destroyed\n"; }
};

class B {
public:
    std::weak_ptr<A> a_ptr;  // â—ï¸ä½¿ç”¨ weak_ptr è§£å†³å¾ªç¯å¼•ç”¨
    ~B() { std::cout << "B destroyed\n"; }
};

int main() {
    std::shared_ptr<A> a = std::make_shared<A>();
    std::shared_ptr<B> b = std::make_shared<B>();

    a->b_ptr = b;
    b->a_ptr = a;  // âœ… ä½¿ç”¨ weak_ptrï¼Œé¿å…å¾ªç¯å¼•ç”¨

    return 0;  // âœ… ç”±äº weak_ptrï¼Œä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼
}
```

ğŸ“Œ **å¦‚æœ `B` ä¹Ÿä½¿ç”¨ `shared_ptr<A>`ï¼Œå¯¹è±¡ä¸ä¼šé‡Šæ”¾ï¼Œå¯¼è‡´** **å†…å­˜æ³„æ¼ï¼ˆå¾ªç¯å¼•ç”¨ï¼‰**ï¼



#### æ™ºèƒ½æŒ‡é’ˆ VS åŸå§‹æŒ‡é’ˆ

| **æ¯”è¾ƒé¡¹**   | **æ™ºèƒ½æŒ‡é’ˆï¼ˆSmart Pointerï¼‰**        | **åŸå§‹æŒ‡é’ˆï¼ˆRaw Pointerï¼‰** |
| ------------ | ------------------------------------ | --------------------------- |
| **æ‰€æœ‰æƒ**   | `unique_ptr` ç‹¬å , `shared_ptr` å…±äº« | ä»…å­˜å‚¨åœ°å€ï¼Œæ— æ‰€æœ‰æƒ        |
| **ç”Ÿå‘½å‘¨æœŸ** | **è‡ªåŠ¨é‡Šæ”¾å†…å­˜**                     | éœ€æ‰‹åŠ¨ `delete`             |
| **å¼‚å¸¸å®‰å…¨** | **å®‰å…¨**ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼               | å¯èƒ½æ³„æ¼                    |
| **å¼•ç”¨è®¡æ•°** | `shared_ptr` æœ‰å¼•ç”¨è®¡æ•°              | æ—                           |
| **å¾ªç¯å¼•ç”¨** | å¯èƒ½å­˜åœ¨ï¼Œä½† `weak_ptr` å¯è§£å†³       | ä¸å­˜åœ¨                      |



#### ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆï¼Ÿ

| **åœºæ™¯**              | **æ¨èæ™ºèƒ½æŒ‡é’ˆ**                                   |
| --------------------- | -------------------------------------------------- |
| ç‹¬å æ‰€æœ‰æƒ            | `std::unique_ptr<T>`                               |
| å…±äº«æ‰€æœ‰æƒ            | `std::shared_ptr<T>`                               |
| é¿å…å¾ªç¯å¼•ç”¨          | `std::weak_ptr<T>`                                 |
| èµ„æºç®¡ç†              | `std::unique_ptr<T>`ï¼ˆæ–‡ä»¶ã€Socketã€æ•°æ®åº“è¿æ¥ç­‰ï¼‰ |
| é¿å…æ‰‹åŠ¨ `new/delete` | `std::make_unique<T>()` / `std::make_shared<T>()`  |



#### æ€»ç»“

1. `std::unique_ptr`ï¼ˆ**ç‹¬å æ‰€æœ‰æƒ**ï¼‰â€”â€” **ä¸å…è®¸æ‹·è´ï¼Œå¯ç§»åŠ¨**ï¼Œç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚
2. `std::shared_ptr`ï¼ˆ**å¼•ç”¨è®¡æ•°**ï¼‰â€”â€” **å¤šä¸ªæŒ‡é’ˆå…±äº«èµ„æº**ï¼Œæœ€åä¸€ä¸ªæŒ‡é’ˆé‡Šæ”¾èµ„æºã€‚
3. `std::weak_ptr`ï¼ˆ**å¼±å¼•ç”¨**ï¼‰â€”â€” **ä¸å½±å“å¼•ç”¨è®¡æ•°**ï¼Œ**è§£å†³ `shared_ptr` å¾ªç¯å¼•ç”¨é—®é¢˜**ã€‚
4. **æ¨èä½¿ç”¨ `std::make_unique<T>()` å’Œ `std::make_shared<T>()` åˆ›å»ºæ™ºèƒ½æŒ‡é’ˆ**ï¼Œæ¯” `new` æ›´å®‰å…¨é«˜æ•ˆã€‚

ğŸ’¡ **å»ºè®®å§‹ç»ˆä¼˜å…ˆä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆï¼Œé¿å…æ‰‹åŠ¨ `new/delete`ï¼Œæé«˜ä»£ç çš„å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ï¼** ğŸš€



### cppé¢å‘å¯¹è±¡

ä¸‰å¤§ç‰¹å¾ï¼šç»§æ‰¿ã€å°è£…ã€å¤šæ€ï¼ˆè¦†ç›–ã€é‡è½½ï¼‰

è®¿é—®ä¿®é¥°ç¬¦ï¼šprivateã€publicã€protected

#### å¤šé‡ç»§æ‰¿

ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ `virtual` ç»§æ‰¿ï¼Ÿ

- å½“å¤šä¸ªåŸºç±»ç»§æ‰¿åŒä¸€ä¸ªåŸºç±»ï¼Œå¹¶ä¸”æ´¾ç”Ÿç±»åˆå¤šé‡ç»§æ‰¿è¿™äº›åŸºç±»æ—¶ï¼Œåº”è¯¥ä½¿ç”¨ `virtual` ç»§æ‰¿ã€‚
- é˜²æ­¢â€œè±å½¢ç»§æ‰¿â€å¯¼è‡´çš„å¤šä»½åŸºç±»å®ä¾‹é—®é¢˜ã€‚

```cpp
#include <iostream>

class A {
public:
    int value;
    A(int v) : value(v) { std::cout << "A constructed\n"; }
};

class B : virtual public A {
public:
    B() : A(20) { std::cout << "B constructed\n"; }
};

class C : virtual public A {
public:
    C() : A(30) { std::cout << "C constructed\n"; }
};

class D : public B, public C {
public:
    D() : A(40) { std::cout << "D constructed\n"; }
};

int main() {
    D d;
    std::cout << "A::value in D: " << d.value << std::endl;
    return 0;
}
```

```css
A constructed   âœ… ç”± D æ„é€  A
B constructed
C constructed
D constructed
A::value in D: 40
```



#### å¤šæ€å®ç°

**å¤šæ€ï¼ˆPolymorphismï¼‰** æ˜¯ C++ é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆOOPï¼‰çš„ä¸‰å¤§ç‰¹æ€§ä¹‹ä¸€ï¼ˆå°è£…ã€ç»§æ‰¿ã€å¤šæ€ï¼‰ã€‚å®ƒå…è®¸ **çˆ¶ç±»æŒ‡é’ˆæˆ–å¼•ç”¨** è°ƒç”¨ **å­ç±»çš„é‡å†™æ–¹æ³•**ï¼Œä»è€Œå®ç° **åŠ¨æ€ç»‘å®šï¼ˆDynamic Bindingï¼‰**ã€‚

**å¤šæ€çš„æ ¸å¿ƒæœºåˆ¶ï¼š**

1. **è™šå‡½æ•°ï¼ˆVirtual Functionï¼‰**
2. **è™šå‡½æ•°è¡¨ï¼ˆVirtual Table, vtableï¼‰**
3. **è™šæŒ‡é’ˆï¼ˆvptrï¼‰**



**ç¤ºä¾‹ï¼šä¸ä½¿ç”¨è™šå‡½æ•°ï¼ˆé™æ€ç»‘å®šï¼‰**

```cpp
#include <iostream>

class Base {
public:
    void show() { std::cout << "Base::show()" << std::endl; }
};

class Derived : public Base {
public:
    void show() { std::cout << "Derived::show()" << std::endl; }
};

int main() {
    Base* ptr = new Derived();
    ptr->show();  // è¾“å‡ºï¼šBase::show()  âŒ å‘ç”Ÿé™æ€ç»‘å®šï¼Œè°ƒç”¨çš„æ˜¯ Base ç‰ˆæœ¬
    delete ptr;
    return 0;
}
```

**âŒ `ptr->show()` è°ƒç”¨çš„æ˜¯ `Base::show()`ï¼Œè€Œä¸æ˜¯ `Derived::show()`ã€‚**
 **åŸå› **ï¼š

- `show()` **ä¸æ˜¯è™šå‡½æ•°**ï¼ŒC++ **ç¼–è¯‘æ—¶ï¼ˆç¼–è¯‘æœŸï¼‰å†³å®šè°ƒç”¨å“ªä¸ªç‰ˆæœ¬ï¼ˆé™æ€ç»‘å®šï¼‰**ã€‚
- **è°ƒç”¨çš„æ˜¯æŒ‡é’ˆçš„ç±»å‹ `Base\*` çš„å‡½æ•°ï¼Œè€Œä¸æ˜¯ `Derived` ç‰ˆæœ¬ã€‚**



**ä½¿ç”¨è™šå‡½æ•°å®ç°å¤šæ€ï¼ˆåŠ¨æ€ç»‘å®šï¼‰**

```cpp
#include <iostream>

class Base {
public:
    virtual void show() { std::cout << "Base::show()" << std::endl; } // è™šå‡½æ•°
};

class Derived : public Base {
public:
    void show() override { std::cout << "Derived::show()" << std::endl; } // é‡å†™
};

int main() {
    Base* ptr = new Derived();
    ptr->show();  // âœ… è¾“å‡ºï¼šDerived::show()  ï¼ˆåŠ¨æ€ç»‘å®šï¼‰
    delete ptr;
    return 0;
}
```

- `Base::show()` æ˜¯ **è™šå‡½æ•°**ï¼ŒC++ **åœ¨è¿è¡Œæ—¶å†³å®šè°ƒç”¨å“ªä¸€ä¸ªç‰ˆæœ¬**ï¼ˆåŠ¨æ€ç»‘å®šï¼‰ã€‚
- `ptr` æŒ‡å‘ `Derived` å¯¹è±¡ï¼Œå› æ­¤ `ptr->show()` è°ƒç”¨ **Derived ç‰ˆæœ¬çš„ `show()`**ã€‚
- åŠ ä¸Šoverrideå…³é”®å­—å¯ä»¥æ›´å¥½åœ°å¸®åŠ©ç¼–è¯‘å™¨æ£€æŸ¥ã€‚



**vtableï¼ˆè™šå‡½æ•°è¡¨ï¼‰**

- **æ¯ä¸ªæ‹¥æœ‰è™šå‡½æ•°çš„ç±»** éƒ½ä¼šæœ‰ä¸€ä¸ª **è™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰**ã€‚
- vtable æ˜¯ä¸€ä¸ª **æŒ‡é’ˆæ•°ç»„**ï¼Œ**å­˜å‚¨è¯¥ç±»çš„è™šå‡½æ•°åœ°å€**ã€‚

**vptrï¼ˆè™šæŒ‡é’ˆï¼‰**

- **æ¯ä¸ªå¯¹è±¡** éƒ½æœ‰ä¸€ä¸ª **éšè—çš„æŒ‡é’ˆï¼ˆvptrï¼‰**ï¼ŒæŒ‡å‘ **è¯¥ç±»çš„ vtable**ã€‚

```cpp
class Base {
public:
    virtual void func1() { std::cout << "Base::func1()" << std::endl; }
    virtual void func2() { std::cout << "Base::func2()" << std::endl; }
};

class Derived : public Base {
public:
    void func1() override { std::cout << "Derived::func1()" << std::endl; }
};
```

**vtable ç»“æ„**

```css
Base vtable:
+-----------------+
| Base::func1()  |
| Base::func2()  |
+-----------------+

Derived vtable:
+-----------------+
| Derived::func1()  |  (è¦†ç›– Base::func1())
| Base::func2()     |  (ç»§æ‰¿ Base::func2())
+-----------------+

å¯¹è±¡ (Derived)
+-------------------+
| vptr -> Derived vtable |
+-------------------+
```

ğŸ“Œ **Derived åªé‡å†™ `func1()`ï¼Œæ‰€ä»¥ `func2()` ä»ç„¶æŒ‡å‘ `Base::func2()`ï¼**



**çº¯è™šå‡½æ•°å’ŒæŠ½è±¡ç±»**

- **çº¯è™šå‡½æ•°æ²¡æœ‰å…·ä½“å®ç°**ï¼Œæ´¾ç”Ÿç±»**å¿…é¡»é‡å†™**å®ƒã€‚
- **æœ‰çº¯è™šå‡½æ•°çš„ç±»å«æŠ½è±¡ç±»ï¼Œä¸èƒ½å®ä¾‹åŒ–**ã€‚

```cpp
#include <iostream>

class Base {
public:
    virtual void show() = 0;  // çº¯è™šå‡½æ•°
};

class Derived : public Base {
public:
    void show() override { std::cout << "Derived::show()" << std::endl; }
};

int main() {
    // Base b; âŒ é”™è¯¯ï¼ŒæŠ½è±¡ç±»ä¸èƒ½å®ä¾‹åŒ–
    Derived d;
    d.show();  // âœ… è¾“å‡ºï¼šDerived::show()
    return 0;
}
```



**è™šææ„å‡½æ•°**

ä¸ºä»€ä¹ˆè¦è™šææ„ï¼Œä¸ºä»€ä¹ˆä¸èƒ½è™šæ„é€ ï¼Ÿ

é€šå¸¸ï¼Œå¦‚æœâ¼€ä¸ªç±»å¯èƒ½è¢«ç»§æ‰¿ï¼Œä¸”åœ¨å…¶æ´¾ç”Ÿç±»ä¸­æœ‰å¯èƒ½ä½¿ç”¨è¯¥åŸºç±»çš„ææ„å‡½æ•°åº”è¯¥å£°æ˜ä¸ºè™šææ„å‡½æ•°ã€‚

- å¦‚æœåŸºç±»çš„ææ„å‡½æ•°ä¸æ˜¯è™šå‡½æ•°ï¼Œå½“**ä½¿ç”¨åŸºç±»æŒ‡é’ˆåˆ é™¤å­ç±»å¯¹è±¡æ—¶**ï¼Œåªä¼šè°ƒç”¨åŸºç±»çš„ææ„å‡½æ•°ï¼Œè€Œä¸ä¼šè°ƒç”¨å­ç±»çš„ææ„å‡½æ•°ï¼Œå¯¼è‡´å­ç±»çš„èµ„æºæ²¡æœ‰æ­£ç¡®é‡Šæ”¾ã€‚
- æ„é€ å‡½æ•°ä¸èƒ½æ˜¯è™šçš„ï¼Œå› ä¸ºæ„é€ æ—¶è¿˜æ²¡æœ‰ vtableï¼Œæ— æ³•é€šè¿‡è™šè¡¨æ‰¾åˆ°æ­£ç¡®çš„æ„é€ å‡½æ•°ã€‚

**å¦‚æœåŸºç±»çš„ææ„å‡½æ•°æ˜¯è™šå‡½æ•°**ï¼Œåˆ™åœ¨åˆ é™¤å¯¹è±¡æ—¶ï¼Œä¼š**å…ˆè°ƒç”¨å­ç±»çš„ææ„å‡½æ•°ï¼Œå†è°ƒç”¨åŸºç±»çš„ææ„å‡½æ•°**ï¼Œç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾ã€‚

```cpp
#include <iostream>

class Base {
public:
    Base() { std::cout << "Base Constructor\n"; }
    virtual ~Base() { std::cout << "Base Destructor\n"; }  // âœ… è®¾ä¸ºè™šå‡½æ•°
};

class Derived : public Base {
public:
    Derived() { std::cout << "Derived Constructor\n"; }
    ~Derived() { std::cout << "Derived Destructor\n"; }  // ç°åœ¨ä¼šè¢«æ­£ç¡®è°ƒç”¨
};

int main() {
    Base* obj = new Derived();  // åŸºç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å¯¹è±¡
    delete obj;  // âœ… å…ˆè°ƒç”¨ Derived ææ„å‡½æ•°ï¼Œå†è°ƒç”¨ Base ææ„å‡½æ•°
}
```

```css
Base Constructor
Derived Constructor
Derived Destructor
Base Destructor
```

âœ… **ç»“æœ**ï¼š

- **å…ˆè°ƒç”¨å­ç±» `Derived` çš„ææ„å‡½æ•°ï¼Œå†è°ƒç”¨åŸºç±» `Base` çš„ææ„å‡½æ•°**ï¼Œç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾ã€‚

å“ªäº›å‡½æ•°ä¸èƒ½è¢«å£°æ˜ä¸ºè™šå‡½æ•°ï¼šæ„é€ å‡½æ•°ã€æ™®é€šå‡½æ•°ã€é™æ€æˆå‘˜å‡½æ•°ã€å‹å…ƒå‡½æ•°ã€å†…è”æˆå‘˜å‡½æ•°ã€‚



#### å‹å…ƒ

**å‹å…ƒå‡½æ•°**

- å…è®¸ä¸€ä¸ªæ™®é€šå‡½æ•°è®¿é—®ç±»çš„ç§æœ‰æˆå‘˜ã€‚
- è¯¥å‡½æ•°ä¸æ˜¯ç±»çš„æˆå‘˜ï¼Œä½†å¯ä»¥è®¿é—®ç±»çš„ç§æœ‰æ•°æ®ã€‚

```cpp
#include <iostream>
using namespace std;

class A {
private:
    int x;

public:
    A(int val) : x(val) {}

    // å‹å…ƒå‡½æ•°å£°æ˜
    friend void show(const A& obj);
};

// å‹å…ƒå‡½æ•°å®šä¹‰
//å¸¸å¼•ç”¨ï¼ˆconst &ï¼‰ æ˜¯ C++ ä¸­çš„ä¸€ç§ç‰¹æ®Šçš„å¼•ç”¨ç±»å‹ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ é˜²æ­¢è¢«å¼•ç”¨çš„å€¼è¢«ä¿®æ”¹ï¼Œæé«˜ç¨‹åºçš„å®‰å…¨æ€§å’Œå¯è¯»æ€§ã€‚
void show(const A& obj) {
    cout << "Private x = " << obj.x << endl;  // âœ… å¯ä»¥è®¿é—®ç§æœ‰å˜é‡ x
}

int main() {
    A a(10);
    show(a);  // è°ƒç”¨å‹å…ƒå‡½æ•°
    return 0;
}

```

**å‹å…ƒç±»**

- å…è®¸ä¸€ä¸ªç±»è®¿é—®å¦ä¸€ä¸ªç±»çš„ç§æœ‰å’Œä¿æŠ¤æˆå‘˜ã€‚
- é€‚ç”¨äºä¸¤ä¸ªç±»å…³ç³»ç´§å¯†ï¼Œä½†ä¸å¸Œæœ›æŠŠæ•°æ®æš´éœ²ç»™æ‰€æœ‰ç±»çš„æƒ…å†µã€‚

```cpp
#include <iostream>
using namespace std;

class B;  // å…ˆå£°æ˜ç±» Bï¼Œé¿å…é”™è¯¯

class A {
private:
    int x;

public:
    A(int val) : x(val) {}

    // å‹å…ƒç±»å£°æ˜
    friend class B;  
};

class B {
public:
    void show(const A& obj) {
        cout << "Accessing private x from class A: " << obj.x << endl;  // âœ… è®¿é—®ç§æœ‰å˜é‡
    }
};

int main() {
    A a(20);
    B b;
    b.show(a);  // é€šè¿‡ B è®¿é—® A çš„ç§æœ‰æˆå‘˜
    return 0;
}

```

**å‹å…ƒæˆå‘˜å‡½æ•°**

- åªè®©å¦ä¸€ä¸ªç±»çš„æŸä¸ªç‰¹å®šæˆå‘˜å‡½æ•°è®¿é—®ç§æœ‰æ•°æ®ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç±»ã€‚
- æ¯”å‹å…ƒç±»çš„æƒé™æ›´å°ï¼Œæ›´ç¬¦åˆå°è£…æ€§ã€‚

```cpp
#include <iostream>
using namespace std;

class A {
private:
    int x;

public:
    A(int val) : x(val) {}

    // è®© B çš„ `show()` æˆå‘˜å‡½æ•°æˆä¸ºå‹å…ƒ
    friend void B::show(const A& obj);
};

class B {
public:
    void show(const A& obj) {
        cout << "B accessing A's private x: " << obj.x << endl;  // âœ… è®¿é—® A çš„ç§æœ‰æˆå‘˜
    }
};

int main() {
    A a(30);
    B b;
    b.show(a);
    return 0;
}

```

**å¸¸è§åº”ç”¨ï¼šé‡è½½`<<`æ“ä½œç¬¦**

å¯¹`operator<<`å‡½æ•°è¿›è¡Œé‡è½½ï¼ŒåŸæœ¬æ˜¯ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼ˆéæˆå‘˜å‡½æ•°ï¼‰ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šçš„æœºåˆ¶ï¼Œå®ƒä¸èƒ½ç›´æ¥è®¿é—®ç±»çš„ç§æœ‰æˆå‘˜

```cpp
#include <iostream>
using namespace std;

class A {
private:
    int x;

public:
    A(int val) : x(val) {}

    // å‹å…ƒå‡½æ•°å£°æ˜
    friend ostream& operator<<(ostream& os, const A& obj);
};

// å‹å…ƒå‡½æ•°å®šä¹‰
ostream& operator<<(ostream& os, const A& obj) {
    os << "x = " << obj.x;  // âœ… è®¿é—®ç§æœ‰æˆå‘˜
    return os;
}

int main() {
    A a(100);
    cout << a << endl;  // âœ… å‹å…ƒå‡½æ•°é‡è½½ <<ï¼Œå¯ä»¥ç›´æ¥æ‰“å°ç§æœ‰æˆå‘˜
    return 0;
}
```





#### æ‹·è´æ„é€ å‡½æ•°

æ‹·è´æ„é€ å‡½æ•°çš„å®šä¹‰æ ¼å¼ï¼š

```cpp
ClassName(const ClassName& other);
```

- **`const ClassName& other`**ï¼šå‚æ•°æ˜¯å¯¹å·²æœ‰å¯¹è±¡çš„**å¸¸å¼•ç”¨**ï¼Œé¿å…æ— æ„ä¹‰çš„é€’å½’æ‹·è´ã€‚
- å¦‚æœæ˜¯`ClassName(const ClassName other)`ï¼Œotherä¼ é€’æ—¶è¦åˆ›å»ºä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œåˆ™å†æ¬¡è°ƒç”¨æ‹·è´æ„é€ å‡½æ•°å¯¼è‡´æ— é™é€’å½’ã€‚
- **ä¸è¿”å›å€¼**ï¼Œå› ä¸ºå®ƒæ˜¯æ„é€ å‡½æ•°ã€‚



**æµ…æ‹·è´ï¼ˆé»˜è®¤æ‹·è´æ„é€ å‡½æ•°ï¼‰**

- é»˜è®¤æ‹·è´æ„é€ å‡½æ•° è¿›è¡Œ â€œæŒ‰ä½å¤åˆ¶â€ï¼Œå¦‚æœå¯¹è±¡åŒ…å«æŒ‡é’ˆæˆå‘˜ï¼Œå¯èƒ½å¯¼è‡´é‡å¤é‡Šæ”¾åŒä¸€å—å†…å­˜ï¼ˆæ‚¬ç©ºæŒ‡é’ˆé—®é¢˜ï¼‰ã€‚

**æ·±æ‹·è´ï¼ˆè‡ªå®šä¹‰æ‹·è´æ„é€ å‡½æ•°ï¼‰**

- æ·±æ‹·è´ï¼ˆDeep Copyï¼‰ éœ€è¦åˆ†é…æ–°å†…å­˜ï¼Œç¡®ä¿æ¯ä¸ªå¯¹è±¡æœ‰è‡ªå·±çš„å‰¯æœ¬ã€‚

å¦‚æœä¸å¸Œæœ›å¯¹è±¡è¢«æ‹·è´ï¼Œä½¿ç”¨ `= delete`ï¼Œæˆ–è€…ä½¿ç”¨ `std::unique_ptr` ä»£æ›¿åŸå§‹æŒ‡é’ˆã€‚

















### std::allocator

`allocator`æ˜¯æ ‡å‡†åº“æä¾›çš„ä¸€ä¸ªé€šç”¨å·¥å…·ï¼Œç”¨äºç®¡ç†å†…å­˜åˆ†é…å’Œé‡Šæ”¾ã€‚å®ƒæ˜¯STLï¼ˆæ ‡å‡†æ¨¡æ¿åº“ï¼‰å®¹å™¨å¦‚`vector`ã€`list`ç­‰èƒŒåè¿›è¡Œå†…å­˜ç®¡ç†çš„æœºåˆ¶ã€‚é€šè¿‡è‡ªå®šä¹‰åˆ†é…å™¨ï¼Œå¼€å‘è€…å¯ä»¥æ§åˆ¶å®¹å™¨å¦‚ä½•è·å–å’Œé‡Šæ”¾å†…å­˜ï¼Œè¿™å¯¹äºä¼˜åŒ–æ€§èƒ½æˆ–ä½¿ç”¨ç‰¹å®šç±»å‹çš„å†…å­˜èµ„æºéå¸¸æœ‰ç”¨ã€‚

```cpp
#include <iostream>
#include <memory> // std::allocatorä½äºè¯¥å¤´æ–‡ä»¶ä¸­

int main() {
    std::allocator<int> alloc; // åˆ›å»ºä¸€ä¸ªç”¨äºåˆ†é…intç±»å‹çš„allocatorå¯¹è±¡
    int* p = alloc.allocate(5); // åˆ†é…èƒ½å­˜å‚¨5ä¸ªintçš„ç©ºé—´

    // æ„é€ è¿™äº›intå¯¹è±¡
    for (size_t i = 0; i < 5; ++i) {
        alloc.construct(&p[i], i); // åˆå§‹åŒ–æ¯ä¸ªå…ƒç´ 
    }

    // ä½¿ç”¨è¿™äº›intå¯¹è±¡...
    for (size_t i = 0; i < 5; ++i) {
        std::cout << p[i] << " ";
    }
    std::cout << std::endl;

    // é”€æ¯è¿™äº›intå¯¹è±¡
    for (size_t i = 0; i < 5; ++i) {
        alloc.destroy(&p[i]); // é”€æ¯æ¯ä¸ªå…ƒç´ 
    }

    alloc.deallocate(p, 5); // é‡Šæ”¾åˆ†é…çš„å†…å­˜

    return 0;
}
```

### new

- **`new`**ï¼šåˆ†é…å†…å­˜å¹¶æ„é€ å¯¹è±¡ï¼Œæ˜¯æœ€å¸¸ç”¨çš„åŠ¨æ€å†…å­˜åˆ†é…æ–¹å¼ã€‚
- **`operator new`**ï¼šåªè´Ÿè´£åˆ†é…å†…å­˜ï¼Œä¸è¿›è¡Œæ„é€ ã€‚å¯ä»¥è¢«é‡è½½ä»¥æä¾›å®šåˆ¶åŒ–çš„å†…å­˜åˆ†é…ç­–ç•¥ã€‚
- **`placement new`**ï¼šåœ¨å·²åˆ†é…çš„å†…å­˜ä¸­æ„é€ å¯¹è±¡ï¼Œé€‚ç”¨äºéœ€è¦ç²¾ç»†æ§åˆ¶å†…å­˜åˆ†é…çš„æƒ…å†µï¼Œå¦‚å†…å­˜æ± å®ç°ã€‚

```cpp
#include <new> // å¿…é¡»åŒ…å«è¿™ä¸ªå¤´æ–‡ä»¶æ¥ä½¿ç”¨placement new

char buffer[sizeof(MyClass)]; // é¢„å…ˆåˆ†é…çš„å†…å­˜
MyClass* obj = new(buffer) MyClass(); // åœ¨bufferä¸­æ„é€ å¯¹è±¡
```

ç†è§£å’Œæ­£ç¡®ä½¿ç”¨è¿™ä¸‰ä¸ªæ¦‚å¿µå¯ä»¥å¸®åŠ©æ›´é«˜æ•ˆåœ°ç®¡ç†å†…å­˜ï¼Œé¿å…å¸¸è§çš„å†…å­˜æ³„æ¼å’Œå…¶ä»–ä¸å†…å­˜ç®¡ç†ç›¸å…³çš„é—®é¢˜ã€‚



### è‡ªæ—‹é”

ä¸€ç§è½»é‡çº§çš„é”æœºåˆ¶ï¼Œç”¨äºå®ç°çº¿ç¨‹åŒæ­¥ã€‚å½“ä¸€ä¸ªçº¿ç¨‹å°è¯•è·å–é”æ—¶ï¼Œå¦‚æœé”å·²ç»è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œå®ƒä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œæ˜¯ä¸æ–­å°è¯•è·å–é”ï¼Œç›´åˆ°æˆåŠŸï¼Œè¿™ç§â€œå¿™ç­‰â€è¡Œä¸ºå°±å«ä½œâ€œè‡ªæ—‹â€ã€‚

åœ¨`fetchRange`å‡½æ•°ä»£ç ä¸­çš„éƒ¨åˆ†ï¼š

```cpp
while (locks_[index].test_and_set(std::memory_order_acquire));
```

- `test_and_set()`æ˜¯åŸå­æ“ä½œï¼Œå®ƒå°†locks_[index]è®¾ç½®ä¸ºtrueï¼Œå¹¶è¿”å›é”çš„åŸå§‹çŠ¶æ€ã€‚
- å¦‚æœè¿”å›å€¼è¡¨ç¤ºé”å·²ç»è¢«å ç”¨ï¼ˆtrueï¼‰ï¼Œçº¿ç¨‹ä¼šç»§ç»­å°è¯•è·å–é”ï¼ˆè‡ªæ—‹ï¼‰ã€‚
- è¿™ç§æ–¹å¼é¿å…äº†çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ã€‚

| è‡ªæ—‹é”                         | äº’æ–¥é”                   |
| ------------------------------ | ------------------------ |
| å¿™ç­‰ï¼Œåå¤å°è¯•è·å–é”           | é˜»å¡ï¼Œçº¿ç¨‹ä¼šè¢«æŒ‚èµ·       |
| é€‚åˆé”æŒæœ‰æ—¶é—´å¾ˆçŸ­çš„åœºæ™¯       | é€‚åˆé”æŒæœ‰æ—¶é—´è¾ƒé•¿çš„åœºæ™¯ |
| æ— éœ€æ“ä½œç³»ç»Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ€§èƒ½é«˜ | éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¼€é”€è¾ƒå¤§ |



## MemoryPool-v1 é¡¹ç›®æ¡†æ¶